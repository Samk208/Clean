
Got it — here’s a single, copy-paste diagnostic you can run to pinpoint exactly why products aren’t appearing in shops. This is read-only and safe. I’m aligning with your “auth-compatible” setup (auth.users + public.profiles + influencer_shop_products) from your prior memory.

Run this in Supabase SQL Editor

Replace :handle with an actual shop handle you expect to work.

```sql
-- ===========================================
-- One-Link Shop/Product Visibility Diagnostic
-- Read-only. Replace :handle with your shop handle.
-- ===========================================

-- 0) Context
select current_user as db_user, current_schema as db_schema;

-- 1) Schema existence checks
select
  exists (select 1 from pg_tables where schemaname='public' and tablename='profiles')               as has_profiles,
  exists (select 1 from pg_tables where schemaname='public' and tablename='influencer_shop_products') as has_influencer_shop_products,
  exists (select 1 from pg_tables where schemaname='public' and tablename='shops')                  as has_shops,
  exists (select 1 from pg_tables where schemaname='public' and tablename='products')               as has_products;

-- 1b) Profiles columns sanity
select column_name, data_type
from information_schema.columns
where table_schema='public' and table_name='profiles'
order by ordinal_position;

-- 1c) ISP (influencer_shop_products) columns and FKs
select column_name, data_type
from information_schema.columns
where table_schema='public' and table_name='influencer_shop_products'
order by ordinal_position;

select conname as fk_name, pg_get_constraintdef(c.oid) as fk_def
from pg_constraint c
join pg_class t on c.conrelid = t.oid
join pg_namespace n on n.oid = t.relnamespace
where n.nspname='public' and t.relname='influencer_shop_products' and c.contype='f';

-- 2) RLS policy summaries (ensure reads/writes expected)
select 'products' as table, policyname, cmd, qual, with_check
from pg_policies where schemaname='public' and tablename='products'
union all
select 'shops' as table, policyname, cmd, qual, with_check
from pg_policies where schemaname='public' and tablename='shops'
union all
select 'profiles' as table, policyname, cmd, qual, with_check
from pg_policies where schemaname='public' and tablename='profiles'
union all
select 'influencer_shop_products' as table, policyname, cmd, qual, with_check
from pg_policies where schemaname='public' and tablename='influencer_shop_products'
order by table, cmd, policyname;

-- 3) Locate the shop by handle and get influencer_id
with shop as (
  select id, influencer_id, handle, name, active
  from public.shops
  where handle = :handle
)
select * from shop;

-- 4) Influencer profile must exist
with shop as (
  select influencer_id from public.shops where handle = :handle
)
select p.id, p.name, p.avatar, p.verified, p.role
from shop s
left join public.profiles p on p.id = s.influencer_id;

-- 5) Published links in influencer_shop_products for that influencer
with shop as (
  select influencer_id from public.shops where handle = :handle
)
select isp.id, isp.product_id, isp.published, isp.custom_title, isp.sale_price, isp.created_at
from public.influencer_shop_products isp
join shop s on s.influencer_id = isp.influencer_id
order by isp.created_at desc
limit 50;

-- 6) Visibility state of linked products (active + in_stock + stock_count > 0)
with shop as (
  select influencer_id from public.shops where handle = :handle
)
select p.id as product_id, p.title, p.active, p.in_stock, p.stock_count, p.price, isp.sale_price
from public.influencer_shop_products isp
join shop s on s.influencer_id = isp.influencer_id
join public.products p on p.id = isp.product_id
where isp.published = true
order by p.updated_at desc;

-- 7) Count visible products per the API formatter rules
with shop as (
  select influencer_id from public.shops where handle = :handle
)
select count(*) as visible_products
from public.influencer_shop_products isp
join shop s on s.influencer_id = isp.influencer_id
join public.products p on p.id = isp.product_id
where isp.published = true
  and p.active = true
  and p.in_stock = true
  and coalesce(p.stock_count, 0) > 0;

-- 8) Supplier role check (writes require profiles.role='supplier' or admin)
-- Show suppliers for all visible products linked to this shop
with shop as (
  select influencer_id from public.shops where handle = :handle
),
visible as (
  select p.supplier_id
  from public.influencer_shop_products isp
  join shop s on s.influencer_id = isp.influencer_id
  join public.products p on p.id = isp.product_id
  where isp.published = true
)
select pr.id as supplier_id, pr.role
from visible v
left join public.profiles pr on pr.id = v.supplier_id
group by pr.id, pr.role;
```

Test the API endpoint

Use the same handle. Choose the command that fits your environment.

- curl:
```bash
curl -sS "http://localhost:3000/api/shop/<handle>" | jq .
```

- PowerShell:
```powershell
Invoke-RestMethod -Method GET "http://localhost:3000/api/shop/<handle>" | ConvertTo-Json -Depth 6
```

How to interpret results

- Products not showing but API ok: true, products: []
  - Check section 7 visible_products. If 0:
    - Ensure `isp.published = true`.
    - Ensure `products.active = true`, `in_stock = true`, `stock_count > 0`.

- 404 “Influencer shop not found”
  - Section 3 shop row missing. Create a `shops` row with that `handle` and a valid `influencer_id`.

- 404 “Influencer user not found”
  - Section 4 shows NULL. The `profiles` row for that influencer id is missing or RLS blocks read.

- 500 “Failed to fetch shop products”
  - Section 2 may show missing or restrictive SELECT on `influencer_shop_products` or join to `products`.

- Suppliers can’t create/update products
  - Section 8 shows supplier `role` not `supplier`. With the new policies in [supabase/migrations/20250917_fix_rls_products_role.sql](cci:7://file:///c:/Users/Lenovo/Desktop/Workspce/vo-onelink-google/supabase/migrations/20250917_fix_rls_products_role.sql:0:0-0:0), writes require `profiles.role = 'supplier'` or `admin`.

Notes

- The API logic you’re exercising is in `app/api/shop/[handle]/route.ts`, which:
  - Reads `shops` by `handle`.
  - Reads `profiles` by `influencer_id`.
  - Reads `influencer_shop_products` joined to `products`, then filters to in-stock, stock_count > 0.

- Documentation in [DATABASE_SCHEMA.md](cci:7://file:///c:/Users/Lenovo/Desktop/Workspce/vo-onelink-google/DATABASE_SCHEMA.md:0:0-0:0) and [supabase/migrations/20250102_initial_schema.sql](cci:7://file:///c:/Users/Lenovo/Desktop/Workspce/vo-onelink-google/supabase/migrations/20250102_initial_schema.sql:0:0-0:0) is outdated relative to the code; the actual flow is “auth-compatible” with `profiles` and `influencer_shop_products` per your previous setup.

Want me to prepare follow-up one-liners to create minimal seed rows if a particular section returns empty? I can tailor exactly to whatever this diagnostic reveals.